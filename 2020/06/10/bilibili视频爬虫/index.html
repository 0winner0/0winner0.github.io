<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>bilibili视频爬虫 | ZHANG JIN的个人博客</title><script src="https://cdn.bootcss.com/valine/1.4.4/Valine.min.js"></script><link rel="stylesheet" href="/css/arknights.css"><link rel="stylesheet" href="https://cdn.bootcss.com/highlight.js/9.18.1/styles/atom-one-dark-reasonable.min.css"><meta name="generator" content="Hexo 4.2.1"></head><body><header><nav><a href="/">Home</a><a href="/about">About</a><a href="/archives">Archives</a></nav></header><main><article><div id="post-bg"><div id="post-title"><div id="post-info"><span>date:<time datetime="2020-06-10T15:41:02.000Z" id="date"> 2020-06-10</time></span><br><span>updated:<time datetime="2020-06-10T15:45:36.309Z" id="updated"> 2020-06-10</time></span></div><h1>bilibili视频爬虫</h1><hr></div><div id="post-content"><h2 id="哔哩哔哩网站-https-www-bilibili-com"><a href="#哔哩哔哩网站-https-www-bilibili-com" class="headerlink" title="哔哩哔哩网站 https://www.bilibili.com/"></a>哔哩哔哩网站 <a href="https://www.bilibili.com/" target="_blank" rel="noopener">https://www.bilibili.com/</a></h2><h3 id="1-接口分析"><a href="#1-接口分析" class="headerlink" title="1. 接口分析"></a>1. 接口分析</h3><h4 id="1-1-视频播放地址分析"><a href="#1-1-视频播放地址分析" class="headerlink" title="1.1 视频播放地址分析"></a>1.1 视频播放地址分析</h4><p>找到一个接口地址 <a href="https://api.bilibili.com/pgc/player/web/playurl?cid=160231833&qn=0&type=&otype=json&avid=82232111&ep_id=307446&fourk=1&fnver=0&fnval=16&session=744e6df0cb039ef30dfb85c20910ed8b" target="_blank" rel="noopener">https://api.bilibili.com/pgc/player/web/playurl?cid=160231833&amp;qn=0&amp;type=&amp;otype=json&amp;avid=82232111&amp;ep_id=307446&amp;fourk=1&amp;fnver=0&amp;fnval=16&amp;session=744e6df0cb039ef30dfb85c20910ed8b</a></p>
<blockquote>
<p>请求参数</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python">&#123;<br>    <span class="hljs-string">"avid"</span>: <span class="hljs-string">"82232426"</span>,<br>    <span class="hljs-string">"cid"</span>: <span class="hljs-string">"140699463"</span>,<br>    <span class="hljs-string">"bvid"</span>: <span class="hljs-string">""</span>,<br>    <span class="hljs-string">"qn"</span>: <span class="hljs-string">"80"</span>, <span class="hljs-comment"># 这个应该表示的是视频的质量 16， 32， 64， 80， 112 不过试了一下112好像没啥用</span><br>    <span class="hljs-string">"type"</span>: <span class="hljs-string">""</span>,<br>    <span class="hljs-string">"otype"</span>: <span class="hljs-string">"json"</span>,<br>    <span class="hljs-string">"ep_id"</span>: <span class="hljs-string">"307447"</span>, <span class="hljs-comment"># 对应每一p集数 episode</span><br>    <span class="hljs-string">"fourk"</span>: <span class="hljs-string">"1"</span>,<br>    <span class="hljs-string">"fnver"</span>: <span class="hljs-string">"0"</span>,<br>    <span class="hljs-string">"fnval"</span>: <span class="hljs-string">"16"</span>,<br>    <span class="hljs-string">"session"</span>: <span class="hljs-string">"c1f003185cac135189816b9625e0880e"</span>,<br>&#125;<br></code></pre></td></tr></table></figure>

<p>根据这个接口返回的<code>json</code>数据找到了，视频的地址<code>base_url</code>还有<code>backup_url</code>（这个<code>backup_url</code>应该是一个备份的<code>url</code>地址）。</p>
<p>视频连接 <a href="https://cn-jsnt-dx-v-11.bilivideo.com/upgcxcode/33/18/160231833/160231833-1-30080.m4s?expires=1584510000&platform=pc&ssig=Xib2ik7EPiPW9o0oj5NLqw&oi=827474433&trid=6763abd7e0794df3b5db3b2ac9b733a3p&nfc=1&nfb=maPYqpoel5MI3qOUX6YpRA==&mid=0" target="_blank" rel="noopener">https://cn-jsnt-dx-v-11.bilivideo.com/upgcxcode/33/18/160231833/160231833-1-30080.m4s?expires=1584510000&amp;platform=pc&amp;ssig=Xib2ik7EPiPW9o0oj5NLqw&amp;oi=827474433&amp;trid=6763abd7e0794df3b5db3b2ac9b733a3p&amp;nfc=1&amp;nfb=maPYqpoel5MI3qOUX6YpRA==&amp;mid=0</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">&#123;<br>    <span class="hljs-string">"expires"</span>: <span class="hljs-string">"1584509100"</span>,<br>    <span class="hljs-string">"platform"</span>: <span class="hljs-string">"pc"</span>,<br>    <span class="hljs-string">"ssig"</span>: <span class="hljs-string">"etgIh6fzpyJHTk7x2UtAag"</span>,<br>    <span class="hljs-string">"oi"</span>: <span class="hljs-string">"827474433"</span>,<br>    <span class="hljs-string">"trid"</span>: <span class="hljs-string">"a719f43365ce4356a5df8a0380d10112p"</span>,<br>    <span class="hljs-string">"nfc"</span>: <span class="hljs-string">"1"</span>,<br>    <span class="hljs-string">"nfb"</span>: <span class="hljs-string">"maPYqpoel5MI3qOUX6YpRA=="</span>,<br>    <span class="hljs-string">"mid"</span>: <span class="hljs-string">"0"</span>,<br>&#125;<br></code></pre></td></tr></table></figure>

<p>当然，我觉得这里的参数不重要，因为可以直接通过i这个<code>json</code>文件获取，不需要自己传值。</p>
<p><img src="/2020/06/10/bilibili%E8%A7%86%E9%A2%91%E7%88%AC%E8%99%AB/playurl_video.png" alt="视频地址"></p>
<p>接着添加必要的请求头<code>refer</code>（一定要加，否者会出现<code>453</code>状态码）还有<code>range: bytes=0-</code>（格式<code>range: byte=a-b</code>表示返回的是部分数据，数据范围为<code>a-b</code>字节，状态码为<code>206</code>，这里改为<code>0-</code>,表示请求全部的数据）当然还有<code>user-agent</code>。然后，得到了一个<code>mp4</code>文件。打开一看，没有声音，才想到是不是<strong>视频和音频文件分开了</strong>，于是又找到了，音频的地址<code>base_url</code>还有<code>backup_url</code> <strong>返回的视频对象有8个应该是编码的不同，还有音频有3个，也是编码不同吧。对这个编码这块就不去研究了，我们默认取第一个。</strong></p>
<p>音频地址 <a href="https://cn-jsnt-dx-v-10.bilivideo.com/upgcxcode/33/18/160231833/160231833-1-30280.m4s?expires=1584510000&platform=pc&ssig=7y7UFpphOOZ_21shPqx4mw&oi=827474433&trid=6763abd7e0794df3b5db3b2ac9b733a3p&nfc=1&nfb=maPYqpoel5MI3qOUX6YpRA==&mid=0" target="_blank" rel="noopener">https://cn-jsnt-dx-v-10.bilivideo.com/upgcxcode/33/18/160231833/160231833-1-30280.m4s?expires=1584510000&amp;platform=pc&amp;ssig=7y7UFpphOOZ_21shPqx4mw&amp;oi=827474433&amp;trid=6763abd7e0794df3b5db3b2ac9b733a3p&amp;nfc=1&amp;nfb=maPYqpoel5MI3qOUX6YpRA==&amp;mid=0</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">&#123;<br>    <span class="hljs-string">"expires"</span>: <span class="hljs-string">"1584509100"</span>,<br>    <span class="hljs-string">"platform"</span>: <span class="hljs-string">"pc"</span>,<br>    <span class="hljs-string">"ssig"</span>: <span class="hljs-string">"Xib2ik7EPiPW9o0oj5NLqw"</span>,<br>    <span class="hljs-string">"oi"</span>: <span class="hljs-string">"827474433"</span>,<br>    <span class="hljs-string">"trid"</span>: <span class="hljs-string">"a719f43365ce4356a5df8a0380d10112p"</span>,<br>    <span class="hljs-string">"nfc"</span>: <span class="hljs-string">"1"</span>,<br>    <span class="hljs-string">"nfb"</span>: <span class="hljs-string">"maPYqpoel5MI3qOUX6YpRA=="</span>,<br>    <span class="hljs-string">"mid"</span>: <span class="hljs-string">"0"</span>,<br>&#125;<br></code></pre></td></tr></table></figure>

<p>视频和音频参数主要的不同在<code>ssig</code>这个参数上</p>
<p><img src="/2020/06/10/bilibili%E8%A7%86%E9%A2%91%E7%88%AC%E8%99%AB/playerurl_audio.png" alt="音频地址"></p>
<p>接下来就要考虑视频和音频的合并了，百度一下，了解到需要使用<code>ffmpeg</code>这个工具，<a href="https://ffmpeg.zeranoe.com/builds/" target="_blank" rel="noopener">下载</a>。配置变量，这样就可以在命令行中的任意位置使用，将<code>bin</code>目录配置在<code>path</code>环境变量中</p>
<p><img src="/2020/06/10/bilibili%E8%A7%86%E9%A2%91%E7%88%AC%E8%99%AB/ffmpeg.png" alt="ffmpeg"></p>
<p>这是安装成功的截图</p>
<p>接下来要安装<code>python</code>的库<code>ffmpy3</code>来使用它，当然你也可以不然装，通过<code>python</code>命令行的方式来运行这个软件的相关的命令。<code>pip install ffmpy3</code> </p>
<p><code>ffmpeg</code>基本用法 <code>usage: ffmpeg [options] [[infile options] -i infile]... {[outfile options] outfile}...</code></p>
<p>将视频和音频合在一起的命令<code>cmd</code>: <code>ffmpeg -i a.mp3 -i b.mp4 c.mp4</code> 将<code>a</code>和<code>b</code>合并为<code>c</code></p>
<p>使用的<code>ffmpy3</code>代码为<code>ffmpy3.FFMPEG(inputs={&quot;a.mp3&quot;: None, &quot;b.mp3&quot;: None}, outputs={&quot;c.mp3&quot;: None})</code></p>
<p>视频和音频合成之后播放成功，一个小目标达成。^_^</p>
<h4 id="1-2-找到ep-id"><a href="#1-2-找到ep-id" class="headerlink" title="1.2 找到ep_id"></a>1.2 找到<code>ep_id</code></h4><p>因为在请求播放地址的接口主要的参数只有<code>ep_id</code>，所以，接下来就要找到，这个<code>ep_id</code>。经过一点点的小插曲，找到了这个<code>ep_id</code>。可以在控制台中输入<code>__INITIAL_STATE__</code>查看关于这个番剧的所有信息。</p>
<p><img src="/2020/06/10/bilibili%E8%A7%86%E9%A2%91%E7%88%AC%E8%99%AB/__INITIAL_STATE__.png" alt="__INITIAL_STATE__"></p>
<p>得到这个数据的接口就是 <a href="https://www.bilibili.com/bangumi/play/ss29310?spm_id_from=xxxxxxx" target="_blank" rel="noopener">https://www.bilibili.com/bangumi/play/ss29310?spm_id_from=xxxxxxx</a> 其中后面这个<code>spm_id_from</code>参数没用，应该记录的是，你从哪一个入口，进来的。注意到：路径中有一个<code>ss29310</code>应该是这个番剧的<code>id</code>值。关于番剧的<code>id</code>如何获取，下面在分析。现在首先得到<code>ep_id</code>。由于这个值，是在<code>html</code>页面的脚本中的，所以，可以通过页面解析拿到。具体怎么拿，应该都会把。不会看我的<code>github</code>上的源码。</p>
<h4 id="1-3-找到ssId"><a href="#1-3-找到ssId" class="headerlink" title="1.3 找到ssId"></a>1.3 找到<code>ssId</code></h4><p>经过上面的几个部分，已经基本能够下载番剧了。但是我们还可以提供一个根据名字下载番剧的<code>api</code>吧。不难找到</p>
<p><a href="[https://api.bilibili.com/x/web-interface/search/all/v2">https://api.bilibili.com/x/web-interface/search/all/v2</a></p>
<p>参数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python">&#123;<br>    <span class="hljs-string">"context"</span>: <span class="hljs-string">""</span>,<br>    <span class="hljs-string">"page"</span>: <span class="hljs-string">"1"</span>, <span class="hljs-comment"># 页数</span><br>    <span class="hljs-string">"order"</span>: <span class="hljs-string">""</span>,<br>    <span class="hljs-string">"keyword"</span>: <span class="hljs-string">"异度侵入"</span>, <span class="hljs-comment"># 关键词</span><br>    <span class="hljs-string">"duration"</span>: <span class="hljs-string">""</span>,<br>    <span class="hljs-string">"tids_1”: "</span><span class="hljs-string">",</span><br><span class="hljs-string">    "</span>tids_2”: <span class="hljs-string">""</span>,<br>    <span class="hljs-string">"__refresh__"</span>: <span class="hljs-string">"true"</span>,<br>    <span class="hljs-string">"__reload__"</span>: <span class="hljs-string">"false"</span>,<br>    <span class="hljs-string">"highlight"</span>: <span class="hljs-string">"1"</span>, <span class="hljs-comment"># 是否带有html标签修饰</span><br>    <span class="hljs-string">"single_column"</span>: <span class="hljs-string">"0"</span>,<br>    <span class="hljs-string">"jsonp"</span>: <span class="hljs-string">"jsonp"</span>, <span class="hljs-comment"># jsonp请求</span><br>    <span class="hljs-string">"callback"</span>: <span class="hljs-string">"__jp3"</span>, <span class="hljs-comment"># 回调函数的名字</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/2020/06/10/bilibili%E8%A7%86%E9%A2%91%E7%88%AC%E8%99%AB/search.png" alt="search"></p>
<p>不难看到，这是一个解决跨域问题的<code>jsonp</code>的请求。经过测试，提取一些参数 <a href="https://api.bilibili.com/x/web-interface/search/all/v2?page=1&keyword=异度侵入" target="_blank" rel="noopener">https://api.bilibili.com/x/web-interface/search/all/v2?page=1&amp;keyword=异度侵入</a></p>
<p><img src="/2020/06/10/bilibili%E8%A7%86%E9%A2%91%E7%88%AC%E8%99%AB/ssid.png" alt="ssid"></p>
<h3 id="2-写业务代码"><a href="#2-写业务代码" class="headerlink" title="2. 写业务代码"></a>2. 写业务代码</h3><p>预知后事如何，请移步到我的<code>gtihub</code></p>
<p>运行截图</p>
<p><img src="/2020/06/10/bilibili%E8%A7%86%E9%A2%91%E7%88%AC%E8%99%AB/run.png" alt="run"></p>
<div id="paginator"></div></div><div id="post-footer"><hr><a href="/2020/06/10/hello-world-1/">hello-world Next →</a><hr></div><div id="bottom-btn"><a id="to-index" href="#post-index" title="index">≡</a><a id="to-top" href="#post-title" title="to top">∧</a></div><details id="reward"><summary>打赏</summary><div id="alipay"><span>支付宝 | Alipay</span><br><img src="/img/Alipay.png"></div><div id="wechat"><span>微信 | WeChat</span><br><img src="/img/WeChat.png"></div></details><div id="Valine"></div><script>new Valine({
 el: '#Valine'
 , appId: ''
 , appKey: ''
 , placeholder: '此条评论委托企鹅物流发送'
})</script></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/"> Dr.DAJINZI01</a></h1><section id="total"><a id="total-archives" href="/archives"><span class="total-title">Archives Total:</span><span class="total-number">3</span></a><div id="total-tags"><span class="total-title">Tags:</span><span class="total-number">2</span></div><div id="total-categories"><span class="total-title">Categories:</span><span class="total-number">2</span></div></section></div><div id="aside-block"><h1>INDEX</h1><div id="post-index"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#哔哩哔哩网站-https-www-bilibili-com"><span class="toc-number">1.</span> <span class="toc-text">哔哩哔哩网站 https:&#x2F;&#x2F;www.bilibili.com&#x2F;</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-接口分析"><span class="toc-number">1.1.</span> <span class="toc-text">1. 接口分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-视频播放地址分析"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1 视频播放地址分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-找到ep-id"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.2 找到ep_id</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-找到ssId"><span class="toc-number">1.1.3.</span> <span class="toc-text">1.3 找到ssId</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-写业务代码"><span class="toc-number">1.2.</span> <span class="toc-text">2. 写业务代码</span></a></li></ol></li></ol></div></div><footer><nobr><span class="text-title">©</span><span class="text-content">1970 to 2020</span></nobr><wbr><nobr><span class="text-title">ICP</span><span class="text-content">——备案号——</span></nobr><wbr><wbr><nobr>published with&nbsp;<a href="http://hexo.io" target="_blank" rel="noopener">Hexo&nbsp;</a></nobr><wbr><nobr>Theme&nbsp;<a href="https://github.com/Yue-plus/hexo-theme-arknights" target="_blank" rel="noopener">Arknight&nbsp;</a></nobr><wbr><nobr>by&nbsp;<a href="https://github.com/Yue-plus" target="_blank" rel="noopener">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/arknights.js"></script></body></html>